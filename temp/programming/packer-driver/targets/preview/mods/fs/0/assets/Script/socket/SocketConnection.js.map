{"version":3,"sources":["file:///D:/Office/mmo_movement/assets/Script/socket/SocketConnection.ts"],"names":["Component","_decorator","Colyseus","ccclass","property","SocketConnection","instance","start","url","useSSL","hostname","includes","port","client","Client","console","log","connect","joinOrCreate","room","sessionId","onLeave","code","isConnected","state","playerMap","onAdd","player","key","addPlayerToWorld","onChange","changes","onPlayerChange","triggerAll","error","send","msg","playerContext"],"mappings":"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","sourcesContent":["\r\nimport { Component, Primitive, TERRAIN_HEIGHT_BASE, _decorator } from 'cc';\r\nimport Colyseus from 'db://colyseus-sdk/colyseus.js';\r\nimport { Player } from '../Player';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('SocketConnection')\r\nexport class SocketConnection extends Component {\r\n\r\n    static instance: SocketConnection;\r\n    playerName: string;\r\n    isConnected: boolean = false;\r\n\r\n    @property hostname = \"localhost\";\r\n    @property port = 2567;\r\n    @property useSSL = false;\r\n\r\n    client!: Colyseus.Client;\r\n    room!: Colyseus.Room;\r\n\r\n    constructor() {\r\n        super();\r\n        SocketConnection.instance = this;\r\n    }\r\n\r\n    start() {\r\n\r\n        // Instantiate Colyseus Client\r\n        // connects into (ws|wss)://hostname[:port]\r\n\r\n        /* let domain = window.location.href.split('/')[2];\r\n        let url = \"ws://\" + domain.split(':')[0] + ':2567'; */\r\n\r\n        let url = `${this.useSSL ? \"wss\" : \"ws\"}://${this.hostname}${([443, 80].includes(this.port) || this.useSSL) ? \"\" : `:${this.port}`}`;\r\n        this.client = new Colyseus.Client(`${this.useSSL ? \"wss\" : \"ws\"}://${this.hostname}${([443, 80].includes(this.port) || this.useSSL) ? \"\" : `:${this.port}`}`);\r\n\r\n        console.log(`Connecting server to ${url}`);\r\n        this.connect();\r\n    }\r\n\r\n\r\n    async connect() {\r\n        try {\r\n            this.room = await this.client.joinOrCreate(\"SumoRoom\");\r\n\r\n            console.log(\"Room joined successfully!\");\r\n            console.log(\"user's sessionId:\", this.room.sessionId);\r\n\r\n            // this.room.onStateChange((state) => {\r\n            //     console.log(\"onStateChange: \", state);\r\n            // });\r\n\r\n            this.room.onLeave((code) => {\r\n                console.log(\"onLeave:\", code);\r\n                this.isConnected = false;\r\n            });\r\n\r\n            /* this.room.state.playerMap.onChange = (player, key) => {\r\n                console.log(player, \"have changes at\", key);\r\n            };\r\n            */\r\n\r\n            this.room.state.playerMap.onAdd = (player, key) => {\r\n                console.log(player, \"has been added at\", key);\r\n\r\n                this.isConnected = true;\r\n\r\n                // add your player entity to the game world!\r\n                this.addPlayerToWorld(player, key);\r\n\r\n                // If you want to track changes on a child object inside a map, this is a common pattern:\r\n                player.onChange = function (changes) {\r\n                    SocketConnection.instance.onPlayerChange(this);\r\n                };\r\n\r\n                // force \"onChange\" to be called immediatelly\r\n                player.triggerAll();\r\n            };\r\n\r\n            \r\n\r\n        } catch (e) {\r\n            console.error(e);\r\n        }\r\n    }\r\n\r\n    send(msg) {\r\n        this.room.send('action', msg)\r\n    }\r\n\r\n    onPlayerChange(playerContext) {\r\n\r\n    }\r\n\r\n    addPlayerToWorld(player, key) {\r\n    }\r\n}\r\n"]}